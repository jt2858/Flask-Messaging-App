<!-- messenger.html - Main chat interface -->
<!-- Include base layout template -->
{%include 'layout.html' %}
<!-- Include messenger-specific JavaScript -->
<script src="{{ url_for('static', filename='js/messenger.js') }}"></script>

<!-- New Chat Creation Menu -->
<div id="newchatmenu" tabindex="0">
    <!-- User search input with search icon -->
    <input type="text" oninput="searchusers()" id="searchusers"><i class="material-icons">search</i>
    <!-- Container for search results -->
    <ul id="userlist">
        <!-- Dynamically populated by JavaScript -->
    </ul>
    <!-- Button to create chat with selected users -->
    <button onclick="createchat()">create chat</button>
</div>
<!-- Main messenger container using CSS Grid -->
<div id="container2">
    <!-- Top bar with username and new chat button -->
    <div id="chatselectorsettings">
        <!-- Display current user's username -->
        <p>{{username}}</p>
        <!-- New group chat button -->
        <i class="material-icons" onclick="shownewchatmenu()" style="margin-right: 15px;">group</i>
    </div>
    <!-- Left sidebar with chat list -->
    <div id="chatselector">
        <ul>
            <!-- Loop through user's existing chats -->
            {% for chat in existing_chats %}
                <!-- Highlight currently active chat and redirect to its page when clicked -->
                <li {%if active_chat_id|string()==chat[3]|string() %}selected="True"{%endif%}onclick='if (event.target==event.currentTarget){window.location.href="{{url_for('messenger', chatid=chat[3]) }}"}'>
                    <!-- Chat profile picture -->
                    <img src="{{chat[2]}}" onclick='if (event.target==event.currentTarget){window.location.href="{{url_for('messenger', chatid=chat[3]) }}"}'>
                    <!-- Chat name/title -->
                    <p onclick='if (event.target==event.currentTarget){window.location.href="{{url_for('messenger', chatid=chat[3]) }}"}'>{{chat[0]}}</p>
                    <!-- Chat options (Delete) -->
                    <div>
                        <!-- More options button -->
                        <i class="material-icons" onblur="console.log(document.activeElement)" onclick="chatselectoroptions()" tabindex="1">more_horiz</i>
                        <!-- Delete chat button with confirmation -->
                        <i class="material-icons" onmousedown='if (confirm("Are you sure you want to delete this chat?")){window.location.href=apiurl + "?deletechat=" + "{{chat[3]}}"}'>delete</i>
                    </div>
                </li>
            {% endfor %}
        </ul>
        
    </div>
    <!-- Main chat area -->
    <div id="chat">
        <!-- Messages container -->
        <ul id="chatcontainer">
            <!-- Loop through message history if chat is selected -->
            {% for message in message_history %}
                {% if message[0]==username %}
                <!-- Messages sent by current user (right-aligned) -->
                    <li sent="True"><p>{{message[1]}}</p></li>
                    <!-- Image attachment for sent message -->
                    <li sent="True"><img class="chatimage" src="{{message[2]}}"></li>
                {%else%}
                <!-- Messages received from others (left-aligned) -->
                    <li received="True"><p>{{message[1]}}</p></li>
                    <!-- Image attachment for received message -->
                    <li received="True"><img class="chatimage" src="{{message[2]}}"></li>
                {%endif%}
            {%endfor%}
        </ul>
        <!-- Message input area at bottom -->
        <div {%if not active_chat_id%} style="display: none;" {%endif%}>
            <!-- Image preview (hidden by default) -->
            <img id="imageuploaddisplay">
            <!-- Hidden file input for image uploads -->
            <input type="file" id="imageupload" name="image" accept="image/*" hidden>
            <!-- Custom file upload button -->
            <label for="imageupload" class="fileupload"><i class="material-icons">add_photo_alternate</i></label>
            <!-- Message text input -->
            <textarea id="messageinput"></textarea>
            <!-- Send message button -->
            <i class="material-icons" onclick="sendMessage()">send</i>
        </div>
    </div>

</div>
